## emscripten module wrapper

This is a wrapper to collect information needed to run WebAssembly modules generated by emscripten.

The idea is that we should be able to run any emscripten generated wasm module, and then post the results as a verified computation using TrueBit. First the script `prepare.js` adds the wrapper to the js file that was generated by emscripten. Then this file
can be ran using Node.js. This will collect the information about calls and memory changes that can be recorded, and used for verified computations. The script first uses the ocaml interpreter to generate a wasm file that has our runtime linked in.
Now this file can be ran using the ocaml off-chain interpreter.

## Installation instructions

Install npm dependencies
```
npm install
```

Install emscripten:

```bash
#You can place this wherever, root directory is recommended
git clone https://github.com/juj/emsdk.git

cd emsdk

LLVM_CMAKE_ARGS="-DLLVM_EXPERIMENTAL_TARGETS_TO_BUILD=WebAssembly" emsdk install sdk-tag-1.37.28-64bit
./emsdk activate sdk-tag-1.37.28-64bit
source ./emsdk_env.sh #this sets up necessary path variables for current terminal session
```

Things you need:
 * emscripten. I recommend using https://github.com/juj/emsdk ... new versions of emscripten will come with new versions of node.js, needed for WebAssembly
 * LLVM/Clang with native WebAssembly support
 * https://github.com/TrueBitFoundation/ocaml-offchain
 * `npm install ipfs-api`

For more detailed instructions, see
https://gist.github.com/nolash/910ac3892d48d2e70232c997ffa9d55e
and Dockerfile at https://hub.docker.com/r/mrsmkl/coindrop/

Edit `prepare.js` to include the correct path for wasm interpreter (default: `../ocaml-offchain/interpreter/wasm`).
Also edit the IPFS host.

## Usage

```
node prepare.js file.js
```

Options:
 * `--file fname`: add the file to the IO block of the task
 * `--arg arg`: add command line argument
 * `--float`: add floating point emulation

